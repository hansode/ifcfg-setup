#!/bin/bash
#
# requires:
#  bash
#  sed, ls
#
# usage:
#  iftree [ NIC ] [ NIC ] ...
#
# url:
#  https://github.com/hansode/ifutils
#

IFTREE_SYSFS_CLASS_NET_PATH_PREFIX=${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX:-/sys/class/net}

function nic_type() {
  local nic=${1}
  [[ -n "${nic}" ]] || return 1
  local type=ethernet

  if   [[ -d ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/bridge ]]; then
    type=bridge
  elif [[ -d ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/bonding ]]; then
    type=bonding
  elif [[ -f ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/tun_flags ]]; then
    type=tap
  elif [[ "$(< ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/ifindex)" != "$(< ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/iflink)" ]]; then
    type=vlan
  elif [[ "$(< ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/type)" == 772 ]]; then
    type=lo
  fi

  echo ${type}
}

function indent() {
  sed "s,^,  ," < /dev/stdin
}

function shownic() {
  local nic=${1}
  [[ -n "${nic}" ]] || return 1

  echo -n "device=${nic} "
  local type=$(nic_type ${nic})

  echo -n "type=${type} "
  case "${type}" in
    ethernet|lo|tap)
      echo
      ;;
    bridge)
      local brif="$(ls ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/brif/)"
      echo brif=\"${brif}\"

      local slave
      for slave in ${brif}; do
        shownic ${slave} | indent
      done
      ;;
    bonding)
      local slaves="$(< ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/bonding/slaves)"
      echo slaves=\"${slaves}\"

      local slave
      for slave in ${slaves}; do
        shownic ${slave} | indent
      done
      ;;
    vlan)
      local iflink=$(< ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}/iflink) master i

      for i in ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/*/ifindex; do
        [[ "$(< ${i})" == "${iflink}" ]] || continue
        master=$(basename ${i%%/ifindex})
      done
      echo master=${master}

      if [[ -n "${master}" ]]; then
        shownic ${master} | indent
      fi
      ;;
    *)
      echo
      ;;
  esac
}

function iftree_cli() {
  local nic

  if [[ ${#} != 0 ]]; then
    while [[ "${1}" ]]; do
      nic=${1}; shift
      [[ -L "${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/${nic}" ]] || continue
      shownic ${nic}
    done
  else
    for nic in ${IFTREE_SYSFS_CLASS_NET_PATH_PREFIX}/*; do
      [[ -L "${nic}" ]] || continue
      shownic $(basename ${nic})
    done
  fi
}

if [[ "${BASH_SOURCE[0]##*/}" == "iftree" ]]; then
  set -e
  set -o pipefail

  iftree_cli "${@}"
fi
